name: CI

on:
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: hashicorp/terraform:latest
      env:
        GITHUB_APP_ID: "${{ secrets.TF_VAR_github_app_id }}"
        GITHUB_APP_INSTALLATION_ID: "${{ secrets.TF_VAR_github_app_id }}"
        GITHUB_APP_PEM_FILE: "${{ secrets.TF_github_app_pem_file }}"
        AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID}}"
        AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY}}"

    steps:
      - uses: actions/checkout@v3

      - name: install git-secret
        run: |
          sudo sh -c "echo 'deb https://gitsecret.jfrog.io/artifactory/git-secret-deb git-secret main' >> /etc/apt/sources.list"
          wget -qO - 'https://gitsecret.jfrog.io/artifactory/api/gpg/key/public' | sudo apt-key add -
          sudo apt-get update && sudo apt-get install -y git-secret
  
          # Testing, that it worked:
          git secret --version

      - name: Terraform Init
        working-directory: ./terraform
        run: make init

